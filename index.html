<!DOCTYPE html>
<html>
<head>
    <title>智能股票决策系统</title>
    <meta charset="utf-8">
    <style>
        #chat-box { height:400px; border:1px solid #ddd; padding:20px; overflow-y:auto }
        .user-msg { background:#e3f2fd; padding:10px; margin:10px; border-radius:8px }
        .bot-msg { background:#f5f5f5; padding:10px; margin:10px; border-radius:8px }
        .loading-msg { color: #666; font-style: italic }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div id="chat-box"></div>
    <input type="text" id="user-input" placeholder="输入投资问题，例如：腾讯可以加仓吗？">
    <button onclick="sendMessage()">发送</button>

    <script>
        // API配置（请检查密钥有效性）
        const CONFIG = {
            deepseek: {
                key: 'sk-ae39dd10b0834dfb9543b92010d23d5b',
                endpoint: 'https://api.deepseek.com/v1/chat/completions'
            },
            juhe: {
                stock: {
                    key: 'd08e60ca8209a253511c39c4fe2a0223',
                    url: 'https://web.juhe.cn/finance/stock/hs'
                },
                news: {
                    key: '68c04ff51f469fd0b99105cca5cca711',
                    url: 'https://apis.juhe.cn/finance/query'
                }
            },
            webhook: 'https://hook.us2.make.com/lo8f3afvqxiw6jx1kke3yy1vpt14xndo'
        }

        // 系统初始化
        window.sendMessage = async function() {
            const userInput = document.getElementById('user-input');
            const input = userInput.value.trim();
            if (!input) return alert('请输入有效问题');

            const btn = document.querySelector('button');
            btn.disabled = true;
            userInput.value = '';
            displayMessage(input, 'user');
            displayMessage("正在获取实时数据...", 'bot', 'loading');

            try {
                // 阶段1：获取实时数据
                const [stock, news] = await Promise.all([
                    getStockData('hk0700'), // 腾讯股票代码
                    getNewsData('腾讯控股')
                ]);

                // 阶段2：生成分析报告
                const analysis = await generateAnalysisReport(input, stock, news);
                
                // 阶段3：保存记录
                await saveAnalysisRecord(input, analysis);

                displayMessage(analysis, 'bot');
                
            } catch (error) {
                console.error('系统错误:', error);
                displayMessage(`服务暂时不可用：${error.message}`, 'bot');
            } finally {
                btn.disabled = false;
                document.querySelector('.loading-msg')?.remove();
            }
        }

        // 核心功能函数
        async function getStockData(gid) {
            const url = new URL(CONFIG.juhe.stock.url);
            url.searchParams.set('key', CONFIG.juhe.stock.key);
            url.searchParams.set('gid', gid);

            const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
            const data = await response.json();
            
            if (data.error_code !== 0) throw new Error(data.reason);
            return data.result;
        }

        async function getNewsData(keyword) {
            const url = new URL(CONFIG.juhe.news.url);
            url.searchParams.set('key', CONFIG.juhe.news.key);
            url.searchParams.set('word', keyword);

            const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
            const data = await response.json();
            
            if (data.error_code !== 0) throw new Error(data.reason);
            return data.result.news.slice(0, 3); // 取最新3条新闻
        }

        async function generateAnalysisReport(question, stock, news) {
            const prompt = `作为专业投资顾问，请根据以下数据回答：${question}
                实时股价：${stock.price}（波动 ${stock.updown}）
                关键指标：市盈率 ${stock.pe} / 市值 ${stock.mkv}
                最新新闻：${news.map(n => `[${n.time}] ${n.title}`).join('\n')}
                要求：1. 300字以内 2. 包含风险评估 3. 给出明确建议`;

            const response = await fetch(CONFIG.deepseek.endpoint, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${CONFIG.deepseek.key}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{ role: "user", content: prompt }],
                    temperature: 0.7
                })
            });

            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function saveAnalysisRecord(question, advice) {
            try {
                await fetch(CONFIG.webhook, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ question, advice })
                });
            } catch (e) {
                console.warn('记录保存失败:', e);
            }
        }

        // 界面功能
        function displayMessage(text, role, type) {
            const chatBox = document.getElementById('chat-box');
            const div = document.createElement('div');
            
            if (type === 'loading') {
                div.className = 'loading-msg';
                div.innerHTML = `<i>${text} <span class="loading-dots">...</span></i>`;
            } else {
                div.className = `${role}-msg`;
                div.textContent = text;
            }
            
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>
